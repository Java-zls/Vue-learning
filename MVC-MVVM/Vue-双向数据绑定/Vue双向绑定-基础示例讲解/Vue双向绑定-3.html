<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Vue双向数据绑定原理</title>
    <style type="text/css">
        * {margin:0; padding:0;list-style:none;font-size:14px; border:0; }
        .container {
            width:600px; height:400px;
            background: lightcoral;
            padding:20px;
            margin:100px auto;
        }
        input[type="text"] {
            display: block;     height: 40px;
            line-height: 40px;  width: 200px;
            text-indent:10px;  margin:10px 0;
            background: #fff;   border-radius: 6px;
            letter-spacing: 1px; font-size: 15px;
        }
        span#msg {
            display:block;  border-radius: 6px;
            line-height: 40px;
            background:lightBlue; margin:20px 0;
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <input type="text" id="a" v-model="text">
        {{text}}
    </div>
    <script type="text/javascript">
        window.onload = function () {

            // 定义观察者
            function observe (obj, vm) {
                Object.keys(obj).forEach(function (key) {
                    // 调用响应函数
                    defineReactive(vm, key, obj[key]);
                })
            }

            function defineReactive (obj, key, val) {
                const dep = new Dependence();
                Object.defineProperty(obj, key, {
                    get: function () {
                        if (Dependence.ref) {
                            dep.addSub(Dependence.ref);
                        }
                        return val;
                    },
                    set: function (newVal) {
                        if (newVal === val) return;
                        val = newVal;

                        // 作为发布者发出通知
                        dep.notify();
                    }
                })
            }

            function Dependence () {
                this.subs = [];
            }
            Dependence.prototype = {
                addSub: function (sub) {
                    this.subs.push(sub);
                },
                notify: function () {
                    this.subs.forEach(function (sub) {
                        console.log(sub);
                        sub.update();
                    })
                }
            };


            // 订阅者 Watcher
            function Watcher (vm, node, name, nodeType) {
                Dependence.ref = this;
                this.name = name;
                this.node = node;
                this.vm = vm;
                this.nodeType = nodeType;

                this.update();

                Dependence.ref = null;
            }
            Watcher.prototype = {
                update: function () {
                    this.get();
                    if (this.nodeType === "text") {
                        this.node.nodeValue = this.value;
                    }
                    if (this.nodeType === "input") {
                        this.node.value = this.value;
                    }
                },
                get: function () {
                    this.value = this.vm[this.name];
                }
            };

            // 节点转换为虚拟 DOM
            function nodeToFragment(node, vm){
                const flag = document.createDocumentFragment();
                let child;
                while(child = node.firstChild) {
                    compile(child, vm);
                    flag.appendChild(child);
                }
                return flag;
            }

            function compile (node, vm) {
                // . 匹配任何字符。 * 前面的项出现0次或多次
                let reg = /\{\{(.*)\}\}/;
                if (node.nodeType === 1) {
                    let attr = node.attributes;
                    for (let i = 0; i < attr.length; i++) {
                        if (attr[i].nodeName === "v-model") {
                            let name = attr[i].nodeValue;
                            node.addEventListener("keyup", function (e) {
                                vm[name] = e.target.value;
                            }, false);
                            node.value = vm[name];
                            node.removeAttribute("v-model");
                        }
                    }
                }
                if (node.nodeType === 3) {
                    if (reg.test(node.nodeValue)) {
                        // 获取到匹配的字符串
                        let name = RegExp.$1;
                        name = name.trim();
                        new Watcher(vm, node, name, "text");
                    }
                }
            }

            function Vue(options) {
                this.data = options.data;
                let data = this.data;
                observe(data, this);
                let id = options.el;
                let dom = nodeToFragment(document.getElementById(id), this);
                document.getElementById(id).appendChild(dom);
            }

            const vm = new Vue({
                el: "container",
                data: {
                    text: "Hello Vue!"
                }
            });
        }
    </script>
</body>
</html>